<!DOCTYPE html>
<html lang="en">

<head>
    <title>Rawer</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <link rel="stylesheet" href="css/fonts.css" type="text/css" />
    <link rel="stylesheet" href="css/grid-columns.css" type="text/css" />
    <link rel="stylesheet" href="css/style.css" type="text/css" />

</head>

<body>
    <header id="main-header">
        <h1 class="h-title">
           Rawer
        </h1>
    </header>
    <div class="grid-container">
        <div class="main-grid-item directory">
            <p><strong>Under Construction</strong></p>
            <p><em>there are many to-dos</em></p>
        </div>
        <div class="main-grid-item articles">
            <article>
                <!-- POST CONTENT TEMPLATE -->

<article class="post-content">
        <a href="entries/2024-09-09_holst.html">#</a>
    <h1>The Planets</h1>
<p>On BBC Radio 4 this morning there was a prog <a href="https://www.bbc.co.uk/sounds/play/m0022t6x">How to Play</a> featuring Holst&#39;s &#39;The Planets&#39;.</p>
<p>Gives me today&#39;s analogy for my recurring problem of how best to spend my time.</p>
<p>My todo list for today might well be changed if some money I&#39;m hoping is coming my way arrives today, but for now I&#39;ll assume it isn&#39;t.</p>
<p>I want to get XMPP up and running asap but I&#39;ve got to a point with #Postcraft where I can start organising my notes better (and putting them online).</p>
<h2>Postcraft/Transmissions</h2>
<ul>
<li>write a top-level list of what I&#39;m working on</li>
<li>set up placeholder Postcraft setups as appropriate</li>
</ul>
<p><a href="https://markmap.js.org/docs/markmap">markmap</a></p>
<p><a href="https://markmap.js.org/docs/packages--markmap-lib">markmap-lib</a></p>
<p><a href="https://markmap.js.org/docs/json-options">markmap JSON Options</a> - note Markdown Frontmatter</p>
<p><code>/home/danny/github-danny/postcraft/danny.ayers.name/content-raw/articles/about/what-am-i-doing.md</code></p>
<p>TODO Postcraft backup transmission
TODO Transmissions conditionals (+ list other constructs somewhere)
TODO todo list extractor</p>
<p>TODO markmap interactive page</p>
<h2>XMPP</h2>
<ul>
<li>get the server working</li>
<li>make a (client) test script</li>
</ul>

</article>
<p class="post-title h-cinzel">
    <a href="entries/2024-09-09_holst.html">
        The Planets
    </a>
</p> <em>2024-09-09</em><!-- POST CONTENT TEMPLATE -->

<article class="post-content">
        <a href="entries/2024-09-08_xmpp-3.html">#</a>
    <h1>Setting up XMPP pt.3</h1>
<p><a href="https://github.com/mathiasertl/xmpp-test">https://github.com/mathiasertl/xmpp-test</a></p>
<pre><code class="language-bash">cd /home/github-other

apt install python-is-python3

git clone https://github.com/mathiasertl/xmpp-test.git

cd xmpp-test

python3 -m venv .venv

source .venv/bin/activate

cd xmpp-test# pip install -r requirements.txt

pip install -r requirements.txt
</code></pre>
<p>deactivate</p>
<p>grrr. Incompatible dependency.</p>
<p><a href="https://stackoverflow.com/questions/72032032/importerror-cannot-import-name-iterable-from-collections-in-python">https://stackoverflow.com/questions/72032032/importerror-cannot-import-name-iterable-from-collections-in-python</a></p>
<p>I could fork &amp; tweak...</p>
<p>but my own code can probably do the same.</p>
<p>I think <a href="https://github.com/danja/dogbot">https://github.com/danja/dogbot</a> was my latest.</p>
<p>Later.</p>
<p>// ejabberdctl register dogbot hyperdata.it
// ejabberdctl change_password dogbot hyperdata.it doggy</p>
<p>nano /etc/ejabberd/ejabberd.yml
ejabberdctl reload_config</p>

</article>
<p class="post-title h-cinzel">
    <a href="entries/2024-09-08_xmpp-3.html">
        Setting up XMPP pt.3
    </a>
</p> <em>2024-09-09</em><!-- POST CONTENT TEMPLATE -->

<article class="post-content">
        <a href="entries/2024-09-08_stormy.html">#</a>
    <h1>Stormy Weather</h1>
<p>I did start looking at server XMPP config again but a thunderstorm means the network is up &amp; down.</p>
<p>Back to #Transmissions <code>ConfigMap</code>.</p>
<p>Hmm. Need docs to make sense of these.</p>
<p>Slight diversion : I&#39;m adding code into <code>DirWalker</code> to ignore markdown files with a name start with <code>_</code> underscore. Hardcoded for now (like accepting <code>.md</code>).</p>

</article>
<p class="post-title h-cinzel">
    <a href="entries/2024-09-08_stormy.html">
        Stormy Weather
    </a>
</p> <em>2024-09-09</em><!-- POST CONTENT TEMPLATE -->

<article class="post-content">
        <a href="entries/2024-09-07_xmpp-2.html">#</a>
    <h1>Setting up XMPP pt.2</h1>
<p>Yesterday I got to this:</p>
<pre><code class="language-bash">nano /etc/ejabberd/ejabberd.yml
ejabberdctl reload_config
ejabberdctl request-certificate all
</code></pre>
<p>When I hit ACME rate limiting. I just tried again:</p>
<pre><code class="language-bash">root@hyperdata:~# ejabberdctl request-certificate all
Error: error
Error: &quot;Challenge failed for domain conference.hyperdata.it: ACME server reported: 178.79.189.240: Invalid response from http://conference.hyperdata.it/.well-known/acme-challenge/XqMA-5eKaFy4hEmuP8jO7TUOzp_wmlvbR4DpuRpMqFY: 404 (error type: unauthorized)&quot;
</code></pre>
<p>At <a href="https://docs.ejabberd.im/admin/configuration/basic/#setting-up-acme">ejabberd setting up ACME</a>:</p>
<pre><code class="language-yaml">listen:
  - module: ejabberd_http
    port: 5280
    tls: false
    request_handlers:
      /.well-known/acme-challenge: ejabberd_acme
</code></pre>
<p>Hah!</p>
<p>I just went to see what was happening on the server with:</p>
<pre><code class="language-bash">lynx http://localhost:5280
</code></pre>
<p>And it gave me a sensible response. Then tried with <code>http://localhost:5280/admin</code> and it was asking for a login.</p>
<p>Ok, so, how about in a desktop browser with <code>https://xmpp.hyperdata.it/admin/</code></p>
<p>Yes! It let me log in as admin.</p>
<p>But,</p>
<blockquote>
<p>Apparently your account has no administration rights in this server. Please check how to grant admin rights in: <a href="https://docs.ejabberd.im/admin/installation/#administration-account">https://docs.ejabberd.im/admin/installation/#administration-account</a></p>
</blockquote>
<p>Docs better at <a href="https://docs.ejabberd.im/admin/install/next-steps/#administration-account">https://docs.ejabberd.im/admin/install/next-steps/#administration-account</a></p>
<p>Added:</p>
<pre><code class="language-bash">acl:
  admin:
     user: admin@hyperdata.it
</code></pre>
<p>and the web interface is showing me stuff.</p>
<p>The Dino XMPP client running on desktop isn&#39;t connecting. Checking my old notes... I mentioned <a href="https://mcabber.com/">mcabber</a> client, but nothing more.</p>
<p>Downloaded Android monocle client to phone (from F-Droid)</p>
<pre><code class="language-bash">ejabberdctl live
...
ERROR: The ejabberd node &#39;ejabberd@localhost&#39; is already running.


ps -aux | grep -i &#39;ejabberd&#39;

kill 1234
</code></pre>
<p>I changed the static fs location in nginx conf to proxy instead. Got another rate limit. Grr.</p>
<p>It was trying to set up certs on <code>hyperdata.it</code>.</p>
<pre><code class="language-bash">hosts:
  - localhost
#  - hyperdata.it
  - xmpp.hyperdata.it
  ejabberdctl reload_config
</code></pre>

</article>
<p class="post-title h-cinzel">
    <a href="entries/2024-09-07_xmpp-2.html">
        Setting up XMPP pt.2
    </a>
</p> <em>2024-09-09</em><!-- POST CONTENT TEMPLATE -->

<article class="post-content">
        <a href="entries/2024-09-06_xmpp.html">#</a>
    <h1>Setting up XMPP</h1>
<p>A little diversion. <a href="https://xmpp.org/">XMPP</a> on <code>hyperdata.it</code>. I took lots of notes last time I set it up, hopefully won&#39;t take long.</p>
<p>First thing is to install <a href="https://docs.ejabberd.im/">ejabberd</a> and set it up with certs &amp; a handful of users. Then connect it to LDAP (already installed).</p>
<p>18:00</p>
<pre><code class="language-bash">apt install ejabberd
...
root@hyperdata:~#  ejabberdctl start
ERROR: The ejabberd node &#39;ejabberd@localhost&#39; is already running.
</code></pre>
<p>Ok...</p>
<pre><code class="language-bash">nano /etc/ejabberd/ejabberd.yml
...
hosts:
  - localhost
  - hyperdata.it
...
ejabberdctl reload_config
ejabberdctl register admin hyperdata.it password
...
User admin@hyperdata.it successfully registered.
</code></pre>
<p>Apparently there should be an admin interface on <a href="https://hyperdata.it:5280/admin/">https://hyperdata.it:5280/admin/</a>
LetsEncrypt time.</p>
<pre><code>service ejabberd stop
mv /etc/ejabberd/ejabberd.pem  /etc/ejabberd/ejabberd.pem.backup

//certbot certonly --webroot -w /etc/ejabberd -d hyperdata.it --force-renewal --rsa-key-size 4096
 certbot certonly -w /etc/ejabberd -d hyperdata.it
 ...
 says current cert is ok



ok, looks like I&#39;ve set up DNS for `xmpp.hyperdata.it`

https://stackoverflow.com/questions/56335966/how-to-renew-lets-encrypt-certificate-in-ejabberd-configured-server
</code></pre>
<p>Hmm. not sure how to make certbot aware of <code>xmpp.hyperdata.it</code> except for adding</p>
<pre><code class="language-bash">nano /etc/nginx/sites-available/xmpp.hyperdata.it.conf
...
server {
    server_name xmpp.hyperdata.it;

    location / {
        proxy_pass http://127.0.0.1:5280;
        proxy_set_header Host $host;
    }
    listen 80;
}
...
ln -s /etc/nginx/sites-available/xmpp.hyperdata.it.conf /etc/nginx/sites-enabled/xmpp.hyperdata.it.conf
systemctl restart nginx
certbot
...chose  xmpp.hyperdata.it
Successfully deployed certificate for xmpp.hyperdata.it
</code></pre>
<p>ufw disable</p>
<p>Hmm. Next...</p>
<pre><code class="language-bash">cat /etc/letsencrypt/live/hyperdata.it/privkey.pem /etc/letsencrypt/live/xmpp.hyperdata.it/fullchain.pem &gt; ejabberd.pem
</code></pre>
<p><a href="https://hyperdata.it:5280/admin/">https://hyperdata.it:5280/admin/</a></p>
<p>nano /etc/ejabberd/ejabberd.yml
add xmpp.hyperdata.it
ejabberdctl reload_config
ejabberdctl register admin hyperdata.it password</p>
<p>admin</p>
<p>alice
bob
canary
danbri
maxf</p>
<p>danja
dogbot
mari</p>
<p>19:00 - reboot, dogwalk</p>
<p>20:00 - back. <code>ejabberd</code> came back fine</p>
<p>Currently <code>https://xmpp.hyperdata.it/</code> is giving me a 502 Bad Gateway (through nginx).</p>
<p>None of the likely HTTP endpoints work. nginx logs...</p>
<p>TODO /home/www/danny.ayers.name/robots.txt and .ico</p>
<p>TODO archive.org for &quot;GET /wordpress/wp-content/uploads/2015/11/dscn6185.jpg HTTP/1.1&quot;, host: &quot;hyperdata.it&quot;</p>
<p>Before I forget - ufw firewall open for whatever XMPP uses</p>
<p><a href="https://stackoverflow.com/questions/3452161/which-ports-does-xmpp-use">https://stackoverflow.com/questions/3452161/which-ports-does-xmpp-use</a></p>
<pre><code class="language-bash">ufw allow 5222
ufw allow 5269
ufw enable
ufw status
</code></pre>
<p>Eyeball config :</p>
<pre><code class="language-bash">nano /etc/ejabberd/ejabberd.yml
</code></pre>
<p>onto : <code>/var/log/ejabberd</code></p>
<p>both <code>ejabberd.log</code> and <code>error.log</code> say it&#39;s not seeing the certfile. Path or permissions?</p>
<p>Check my notes...</p>
<blockquote>
<p>THISSSSSSS
certbot --key-type ecdsa --cert-name xmpp.hyperdata.it</p>
</blockquote>
<p>Hmm. That looks like it&#39;s ok already.</p>
<pre><code class="language-yaml">certfiles:
  - &quot;/etc/ejabberd/ejabberd.pem&quot;
#  - /etc/letsencrypt/live/localhost/fullchain.pem
#  - /etc/letsencrypt/live/localhost/privkey.pem
---
adding

- /etc/letsencrypt/live/hyperdata.it/fullchain.pem
- /etc/letsencrypt/live/hyperdata.it/privkey.pem
- /etc/letsencrypt/live/xmpp.hyperdata.it/fullchain.pem
- /etc/letsencrypt/live/xmpp.hyperdata.it/privkey.pem
---
ejabberdctl reload_config
</code></pre>
<p>Hmm. why is the first one in quotes?</p>
<p><a href="https://docs.ejabberd.im/admin/configuration">https://docs.ejabberd.im/admin/configuration</a></p>
<pre><code class="language-bash">ejabberdctl request-certificate all
Error: error
Error: &quot;Challenge failed for domain conference.hyperdata.it: ACME server reported: 178.79.189.240: Invalid response from http://conference.hyperdata.it/.well-known/acme-challenge/Wy7YZJQD9wGdOLI9tyv2oKyTTktvnGtWVgIaEhd1qZg: 404 (error type: unauthorized)&quot;
</code></pre>
<p><a href="https://www.process-one.net/blog/ejabberd-xmpp-server-useful-configuration-steps/">https://www.process-one.net/blog/ejabberd-xmpp-server-useful-configuration-steps/</a></p>
<p>suggests A records for :</p>
<ul>
<li>conference</li>
<li>proxy</li>
<li>pubsub</li>
<li>upload</li>
</ul>
<p>My DNS aready has :</p>
<pre><code>conference 10800 IN CNAME hyperdata.it.
</code></pre>
<p>etc.</p>
<p>I saw mention of <code>chat</code> somewhere too - might as well add that too.</p>
<p>It&#39;s poking at the filesystem, so I guess I should make dirs &amp; nginx config for those.</p>
<pre><code class="language-bash">root@hyperdata:/home/www# tree xmpp
xmpp
├── chat
├── conference
├── proxy
├── pubsub
└── upload
</code></pre>
<p><a href="https://foaf-retro.hyperdata.it/">https://foaf-retro.hyperdata.it/</a></p>
<pre><code>server {
    listen 80;
    server_name chat.hyperdata.it;

    # Hide nginx version
    server_tokens off;

    location / {
        root /home/www/xmpp/chat;
        index index.html index.htm index.ttl;
        try_files $uri $uri/ =404;
    }
}

server {
    listen 80;
    server_name conference.hyperdata.it;

    # Hide nginx version
    server_tokens off;

    location / {
        root /home/www/xmpp/conference;
        index index.html index.htm index.ttl;
        try_files $uri $uri/ =404;
    }
}

server {
    listen 80;
    server_name proxy.hyperdata.it;

    # Hide nginx version
    server_tokens off;

    location / {
        root /home/www/xmpp/proxy;
        index index.html index.htm index.ttl;
        try_files $uri $uri/ =404;
    }
}
server {
    listen 80;
    server_name pubsub.hyperdata.it;

    # Hide nginx version
    server_tokens off;

    location / {
        root /home/www/xmpp/pubsub;
        index index.html index.htm index.ttl;
        try_files $uri $uri/ =404;
    }
}
server {
    listen 80;
    server_name upload.hyperdata.it;

    # Hide nginx version
    server_tokens off;

    location / {
        root /home/www/xmpp/upload;
        index index.html index.htm index.ttl;
        try_files $uri $uri/ =404;
    }
}
</code></pre>
<p>While I&#39;m here :</p>
<pre><code>server {
    listen 80;
    server_name kia.hyperdata.it;

    # Hide nginx version
    server_tokens off;

    location / {
        root /home/www/kia;
        index index.html index.htm index.ttl;
        try_files $uri $uri/ =404;
    }
}

...
ln -s /etc/nginx/sites-available/kia.hyperdata.it.conf /etc/nginx/sites-enabled/kia.hyperdata.it.conf
nginx -t
systemctl restart nginx
certbot
</code></pre>
<p>KIA done.</p>
<p>Back to :</p>
<pre><code class="language-bash">ejabberdctl request-certificate all
</code></pre>
<p>Grrr! Tucked away in the docs it says you have to turn off TLS first :</p>
<pre><code>listen:
  -
    module: ejabberd_http
    port: 5280
    tls: false
    request_handlers:
      /.well-known/acme-challenge: ejabberd_acme
</code></pre>
<pre><code class="language-bash">nano /etc/ejabberd/ejabberd.yml
ejabberdctl reload_config
ejabberdctl request-certificate all
</code></pre>
<blockquote>
<p>Error: &quot;ACME server reported: Error creating new order :: too many failed authorizations recently: see <a href="https://letsencrypt.org/docs/failed-validation-limit/">https://letsencrypt.org/docs/failed-validation-limit/</a> (error type: rateLimited)&quot;</p>
</blockquote>
<p>certbot has a dry run option, does this?</p>
<p>Ok, enough for today.</p>
<p>21:37</p>
<p>my hosts</p>
<pre><code>root@hyperdata:/etc/nginx/sites-available# ls ../sites-enabled/
danny.ayers.name.conf         fuseki.conf            ps.hyperdata.it.conf  strandz.it.conf
elfquake.org.conf             hyperdata.it.conf      ps.strandz.it.conf    xmpp.hyperdata.it.conf
foaf-retro.hyperdata.it.conf  kia.hyperdata.it.conf  solid.conf
</code></pre>

</article>
<p class="post-title h-cinzel">
    <a href="entries/2024-09-06_xmpp.html">
        Setting up XMPP
    </a>
</p> <em>2024-09-09</em>
            </article>
        </div>
        <div class="main-grid-item about">
            <!--
            <h2>About</h2>
            
            -->
        </div>
    </div>
</body>

</html>